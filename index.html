<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitaNuova Simulator Pro - Multi-Prodotto</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF2D55;
            --secondary: #0066CC;
            --tertiary: #FFFFFF;
            --dark-bg: #1A1A1A;
            --light-bg: #F5F5F7;
            --border: #E5E5EA;
            --text-dark: #333333;
            --text-light: #666666;
            --success: #28A745;
            --warning: #FFC107;
            --danger: #E74C3C;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 20px;
        }

        .internal-use-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
            z-index: 1000;
            letter-spacing: 0.5px;
        }

        .login-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-box h1 {
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 700;
        }

        .login-box .subtitle {
            color: var(--text-light);
            margin-bottom: 30px;
            font-size: 12px;
        }

        .login-box .disclaimer {
            background: #FFF3CD;
            border-left: 4px solid var(--warning);
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 12px;
            text-align: left;
            color: #856404;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 13px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 45, 85, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), #FF3B30);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 45, 85, 0.3);
        }

        .users-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }

        .user-btn {
            padding: 10px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--secondary);
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .user-btn:hover {
            background: var(--secondary);
            color: white;
        }

        .user-btn.selected {
            background: var(--secondary);
            color: white;
        }

        .app-container {
            display: none;
            min-height: 100vh;
            background: white;
        }

        .app-container.active {
            display: block;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 18px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-dark);
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 16px;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .compare-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .compare-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .compare-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .compare-card.selected {
            border-color: var(--primary);
            background: rgba(255, 45, 85, 0.05);
        }

        .compare-card input[type="checkbox"] {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .compare-card h4 {
            color: var(--primary);
            margin-bottom: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .compare-card p {
            margin: 5px 0;
            font-size: 12px;
            color: var(--text-light);
        }

        .results-section {
            background: var(--light-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .result-card {
            background: white;
            border-left: 4px solid var(--secondary);
            padding: 15px;
            border-radius: 8px;
        }

        .result-card.primary {
            border-left-color: var(--primary);
        }

        .result-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 600;
        }

        .result-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 8px;
        }

        .chart-container {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            height: 400px;
        }

        .table-container {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: rgba(255, 45, 85, 0.03);
        }

        .buttons-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: white;
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--secondary);
            color: white;
        }

        .product-description {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .product-description h4 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 14px;
        }

        .export-btn {
            background: white;
            border: 1px solid #4285F4;
            color: #4285F4;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            background: #4285F4;
            color: white;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .alert-danger {
            background: #F8D7DA;
            border-left: 4px solid #DC3545;
            color: #721C24;
        }

        .alert-warning {
            background: #FFF3CD;
            border-left: 4px solid #FFC107;
            color: #856404;
        }

        .alert-info {
            background: #D1ECF1;
            border-left: 4px solid #0C5460;
            color: #0C5460;
        }

        /* ===== AI ASSISTANT STYLES ===== */
        <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VitaNuova Simulator Pro - AI Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #FF2D55;
            --secondary: #0066CC;
            --light-bg: #F5F5F7;
            --border: #E5E5EA;
            --text-dark: #333333;
            --text-light: #666666;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
        }

        /* [CSS completo da vitanuova-fixed.html] */

        .ai-assistant-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: linear-gradient(135deg, #FF2D55, #FF3B30);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 45, 85, 0.3);
            z-index: 998;
        }

        #ai-chat-panel {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 14px;
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        .ai-chat-header {
            background: linear-gradient(135deg, #FF2D55, #FF3B30);
            color: white;
            padding: 16px 18px;
            display: flex;
            justify-content: space-between;
        }

        #ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #F5F5F7;
        }

        .ai-message {
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            max-width: 90%;
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #FF2D55, #FF3B30);
            color: white;
            border-radius: 14px 3px 14px 14px;
        }

        .bot-message {
            align-self: flex-start;
            background: white;
            color: #333;
            border: 1px solid #E5E5EA;
            border-radius: 3px 14px 14px 14px;
        }

        .ai-chat-input-area {
            display: flex;
            gap: 8px;
            padding: 12px;
            background: white;
            border-top: 1px solid #E5E5EA;
        }

        #ai-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            font-size: 13px;
        }

        .ai-chat-input-area button {
            padding: 10px 18px;
            background: linear-gradient(135deg, #FF2D55, #FF3B30);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="ai-chat-panel">
        <div class="ai-chat-header">
            <h3 style="margin: 0; font-size: 15px;">ü§ñ AI Assistant</h3>
            <button onclick="AIAssistant.toggleChat()" style="background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer;">‚úï</button>
        </div>
        <div class="ai-chat-messages" id="ai-messages"></div>
        <div class="ai-chat-input-area">
            <input type="text" id="ai-input" placeholder="Fai una domanda..." />
            <button onclick="AIAssistant.sendMessage()">Invia</button>
        </div>
    </div>

    <button class="ai-assistant-btn" onclick="AIAssistant.toggleChat()">ü§ñ Chiedi all'AI</button>

    <script>
        const AIAssistant = {
            conversationHistory: [],
            isOpen: false,

            patterns: {
                targetAmount: /(?:quanto|quanti|come)\s+(?:mi\s+serve|devo|metto)\s+(?:risparmiare|versare).*?(?:al\s+mese|annuale|ogni|mese|anno)?.*?(\d+[.,]?\d*)/i,
                timeToTarget: /(?:quanto\s+tempo|quanti\s+anni|in\s+quanto)\s+(?:ci\s+metto|impiego|serve).*?(?:a\s+)?raggiungere.*?(\d+[.,]?\d*)/i,
                whichProduct: /(?:quale|che|chi).*?mi\s+(?:conviene|serve|suggerisci).*?(?:PAC|TFR|investimenti?)/i,
                strategy: /(?:cosa|come|strategia|piano)\s+(?:devo|faccio|fare).*?(?:mettere\s+da\s+parte|risparmiare|accumulare)/i,
                directAdvice: /(?:ho|posso|metto).*?(?:mese|mensile|‚Ç¨|euro).*?(?:obiettivo|‚Ç¨|euro|k)/i,
                disponibleTarget: /(?:ha\s+a\s+disposizione|disponib(?:ile|i)?)\s+(\d+).*?(?:vuole|target|obiettivo)\s+(\d+)/i,
                tfrAge: /(?:ho|anni|cliente\s+di|per\s+(?:un|chi).*?)\s+(\d+)\s+anni.*?(?:TFR|dove|quale|cosa|conviene)/i,
                tfrStipendio: /(?:stipendio|guadagno|ho)\s+(\d+).*?(?:k|annui|annuale).*?(?:TFR|quale|conviene|mi)/i
            },

            init() {
                const input = document.getElementById('ai-input');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            },

            toggleChat() {
                this.isOpen = !this.isOpen;
                const panel = document.getElementById('ai-chat-panel');
                panel.style.display = this.isOpen ? 'flex' : 'none';

                if (this.isOpen && this.conversationHistory.length === 0) {
                    this.addBotMessage('Ciao! üëã Sono il tuo AI Assistant.\n\nPosso aiutarti con:\nüí∞ "ho 200‚Ç¨ al mese e voglio 10k"\nüéØ "ha 300‚Ç¨ disponibili e vuole 50k"\nüìÖ "ho 25 anni, dove TFR?"\nüíº "stipendio 40k, quale TFR?"\n\nE molto altro!');
                }
            },

            sendMessage() {
                const input = document.getElementById('ai-input');
                const message = input.value.trim();
                if (!message) return;

                this.addUserMessage(message);
                input.value = '';

                setTimeout(() => {
                    const response = this.processQuery(message);
                    this.addBotMessage(response);
                }, 500);
            },

            processQuery(question) {
                const numeri = question.match(/\d+/g);

                // 1. DOMANDA DIRETTA: Ho X‚Ç¨/mese e Y‚Ç¨ obiettivo
                if (numeri && numeri.length >= 2 && this.patterns.directAdvice.test(question)) {
                    const rataMensile = parseInt(numeri[0]);
                    const obiettivo = parseInt(numeri[1]);

                    if (rataMensile > 0 && rataMensile < 100000 && obiettivo > rataMensile && obiettivo < 1000000) {
                        const rataAnnuale = rataMensile * 12;
                        const rendimento = 0.045;
                        const anni = Math.log(1 + (obiettivo * rendimento / rataAnnuale)) / Math.log(1 + rendimento);
                        const mesi = Math.round((anni - Math.floor(anni)) * 12);

                        let pacSuggerito = '';
                        if (rataAnnuale >= 600 && rataAnnuale <= 24000) {
                            pacSuggerito = 'üáÆüáπ PAC Italiana (Bilanciata o Aggressiva)';
                        } else if (rataAnnuale >= 1800 && rataAnnuale <= 12000) {
                            pacSuggerito = 'üî∑ PAC Vittoria Valore Futuro';
                        } else if (rataAnnuale >= 1000 && rataAnnuale <= 6000) {
                            pacSuggerito = 'üéØ PAC Allianz Goal Driven';
                        }

                        return `‚úÖ Piano personalizzato!\n\nüí∞ Rata: ‚Ç¨${rataMensile}/mese (‚Ç¨${rataAnnuale}/anno)\nüéØ Obiettivo: ‚Ç¨${obiettivo.toLocaleString('it-IT')}\n‚è±Ô∏è Tempo: ${Math.floor(anni)} anni ${mesi} mesi\n\nüèÜ Suggerito: ${pacSuggerito}`;
                    }
                }

                // 2. DOMANDA: Ha a disposizione X e vuole Y
                if (this.patterns.disponibleTarget.test(question)) {
                    const match = question.match(this.patterns.disponibleTarget);
                    if (match) {
                        const disponibile = parseInt(match[1]);
                        const target = parseInt(match[2]) * (question.match(/k|mila/) ? 1000 : 1);

                        if (disponibile > 0 && target > disponibile) {
                            const rataAnnuale = disponibile * 12;
                            const anni = Math.log(1 + (target * 0.045 / rataAnnuale)) / Math.log(1.045);
                            return `‚úÖ Piano cliente!\n\nüí∞ Disponibile: ‚Ç¨${disponibile}/mese\nüéØ Target: ‚Ç¨${target.toLocaleString('it-IT')}\n‚è±Ô∏è Tempo: ${Math.floor(anni)} anni\n\nüèÜ Consigliato: PAC Italiana`;
                        }
                    }
                }

                // 3. DOMANDA: TFR per et√† X
                if (this.patterns.tfrAge.test(question)) {
                    const match = question.match(this.patterns.tfrAge);
                    if (match) {
                        const eta = parseInt(match[1]);
                        let consiglio = '';

                        if (eta < 25) {
                            consiglio = 'üöÄ GIOVANE - Rischio alto\nüìà Profilo: DINAMICO (6,5%)\n‚Ä¢ 40+ anni di accumulo\n‚Ä¢ Max crescita';
                        } else if (eta < 35) {
                            consiglio = '‚öñÔ∏è EQUILIBRATO\n‚öñÔ∏è Profilo: BILANCIATO (4,5%)\n‚Ä¢ 30-35 anni\n‚Ä¢ Buon equilibrio';
                        } else if (eta < 50) {
                            consiglio = 'üìä PRUDENTE\nüìä Profilo: CONSERVATIVO (3%)\n‚Ä¢ 15-20 anni\n‚Ä¢ Protezione capitale';
                        } else {
                            consiglio = 'üõ°Ô∏è MASSIMA PROTEZIONE\nüõ°Ô∏è Profilo: CONSERVATIVO (2,5%)\n‚Ä¢ Rischio minimo\n‚Ä¢ Cedole regolari';
                        }

                        return `üí° TFR per ${eta} anni\n\n${consiglio}`;
                    }
                }

                // 4. DOMANDA: TFR con stipendio
                if (this.patterns.tfrStipendio.test(question)) {
                    const match = question.match(this.patterns.tfrStipendio);
                    if (match) {
                        const stipendio = parseInt(match[1]);
                        const tfrAnnuale = (stipendio * 13.5) / 12;
                        const tfr30anni = tfrAnnuale * 30;

                        let profilo = 'BILANCIATO (4,5%)';
                        if (stipendio < 25000) profilo = 'CONSERVATIVO (3%)';
                        else if (stipendio > 60000) profilo = 'DINAMICO (6,5%)';

                        return `üí∞ TFR con ‚Ç¨${stipendio.toLocaleString('it-IT')}/anno\n\nüìä TFR annuale: ‚Ç¨${tfrAnnuale.toFixed(0)}\nüìà Potenziale 30 anni: ‚Ç¨${tfr30anni.toFixed(0)}\n\nüèÜ Profilo: ${profilo}`;
                    }
                }

                // 5. DOMANDA: Quanto risparmiare per X
                if (this.patterns.targetAmount.test(question)) {
                    const match = question.match(this.patterns.targetAmount);
                    const target = parseFloat(match[1].replace(',', '.'));
                    const durata = 10;
                    const rataAnnuale = target / (((1.045 ** durata - 1) / 0.045));
                    return `üí° Per ‚Ç¨${target.toLocaleString('it-IT')} in ${durata} anni:\n\nüìä Rata mensile: ‚Ç¨${(rataAnnuale/12).toFixed(2)}\nüìä Rata annuale: ‚Ç¨${rataAnnuale.toFixed(2)}`;
                }

                // 6. DOMANDA: Quale prodotto
                if (this.patterns.whichProduct.test(question)) {
                    return `üìä Dipende dagli obiettivi:\n\nüî∑ Vittoria: Rischio basso, 4%\nüáÆüáπ Italiana: Compromesso, 4,5%\nüéØ Allianz: Flessibilit√† massima`;
                }

                // 7. DOMANDA: Strategia
                if (this.patterns.strategy.test(question)) {
                    return `üí∞ Strategia consigliata:\n\n1Ô∏è‚É£ Obiettivo\n2Ô∏è‚É£ Orizzonte temporale\n3Ô∏è‚É£ Rata mensile\n4Ô∏è‚É£ Scegli prodotto\n5Ô∏è‚É£ Rivedi ogni anno`;
                }

                return `ü§î Domande che posso aiutarti:\n\n‚Ä¢ "ho 300‚Ç¨ al mese e voglio 50k"\n‚Ä¢ "ha 400‚Ç¨ disponibili e vuole 100k"\n‚Ä¢ "ho 30 anni dove TFR?"\n‚Ä¢ "stipendio 50k quale TFR?"`;
            },

            addUserMessage(text) {
                const messagesDiv = document.getElementById('ai-messages');
                const msgEl = document.createElement('div');
                msgEl.className = 'ai-message user-message';
                msgEl.textContent = text;
                messagesDiv.appendChild(msgEl);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            },

            addBotMessage(text) {
                const messagesDiv = document.getElementById('ai-messages');
                const msgEl = document.createElement('div');
                msgEl.className = 'ai-message bot-message';
                msgEl.textContent = text;
                messagesDiv.appendChild(msgEl);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            AIAssistant.init();
        });
    </script>
</body>
    <!-- LOGIN SECTION -->
    <div id="login" class="login-container">
        <div class="internal-use-badge">
            ‚ö†Ô∏è USO INTERNO<br>ESCLUSIVO
        </div>

        <div class="login-box">
            <h1>üî∑ VitaNuova Simulator Pro</h1>
            <p class="subtitle">Multi-Prodotto ‚Ä¢ Uso Interno</p>

            <div class="login-box disclaimer">
                ‚ö†Ô∏è <strong>ATTENZIONE:</strong> Materiale ad esclusivo uso interno. Dati aggiornati al 31/10/2025. Non diffondere a terzi.
            </div>

            <div class="form-group">
                <label>üë§ Seleziona Utente:</label>
                <div class="users-list">
                    <button class="user-btn" onclick="selectUser(this, 'Patrizia')">Patrizia</button>
                    <button class="user-btn" onclick="selectUser(this, 'Gianluca')">Gianluca</button>
                    <button class="user-btn" onclick="selectUser(this, 'Pippo')">Pippo</button>
                    <button class="user-btn" onclick="selectUser(this, 'Francesca')">Francesca</button>
                </div>
            </div>

            <div class="form-group">
                <label for="pwd">üîë Password:</label>
                <input type="password" id="pwd" placeholder="Inserisci password">
            </div>

            <button class="btn" onclick="login()">ACCEDI</button>
        </div>
    </div>

    <!-- APP SECTION -->
    <div id="app" class="app-container">
        <div class="header">
            <h1>üî∑ VitaNuova Simulator Pro</h1>
            <p class="header-subtitle">Simulatore Multi-Prodotto - Piani di Accumulo, TFR, Investimenti</p>
            <div class="user-info">
                <span>üë§ <strong id="userName"></strong></span>
                <button class="logout-btn" onclick="logout()">Esci</button>
            </div>
        </div>

        <div class="container">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('tab-pac', this)">üìä PAC Confronto</button>
                <button class="tab-btn" onclick="switchTab('tab-tfr', this)">üí∞ TFR vs Azienda</button>
                <button class="tab-btn" onclick="switchTab('tab-investimenti', this)">üíº Investimenti</button>
                <button class="tab-btn" onclick="switchTab('tab-top3', this)">üèÜ Top 3 Prodotti</button>
                <button class="tab-btn" onclick="switchTab('tab-analisi', this)">üî¨ Analisi Avanzata</button>
                <button class="tab-btn" onclick="switchTab('tab-info', this)">‚ÑπÔ∏è Info Prodotti</button>
            </div>

            <!-- TAB 1: PAC -->
            <div id="tab-pac" class="tab-content active">
                <div class="product-description">
                    <h4>üìã Piani di Accumulo - Confronto Multi-Prodotto</h4>
                    <p>Seleziona i prodotti, configura i parametri e confronta i risultati. Dati validati dai prospetti ufficiali.</p>
                </div>

                <div class="form-section">
                    <h3>1Ô∏è‚É£ Seleziona Prodotti da Confrontare</h3>
                    <div class="compare-section">
                        <div class="compare-card" onclick="toggleProduct(this, 'pac1')">
                            <input type="checkbox" id="pac1-check">
                            <h4>PAC Valore Futuro</h4>
                            <p><strong>Compagnia:</strong> Vittoria</p>
                            <p><strong>Min/Max:</strong> ‚Ç¨1.800 - ‚Ç¨12.000</p>
                            <p><strong>Carichi:</strong> 5% | <strong>Fee:</strong> 3,20%</p>
                            <p><strong>Rendimento:</strong> 4%</p>
                        </div>

                        <div class="compare-card" onclick="toggleProduct(this, 'pac2a')">
                            <input type="checkbox" id="pac2a-check">
                            <h4>üíº Italiana Bilanciata</h4>
                            <p><strong>Compagnia:</strong> Italiana</p>
                            <p><strong>Min/Max:</strong> ‚Ç¨600 - ‚Ç¨24.000</p>
                            <p><strong>Carichi:</strong> 8% + 2% | <strong>Fee:</strong> 1,75%</p>
                            <p><strong>Rendimento:</strong> 4,5%</p>
                        </div>

                        <div class="compare-card" onclick="toggleProduct(this, 'pac2b')">
                            <input type="checkbox" id="pac2b-check">
                            <h4>üöÄ Italiana Aggressiva</h4>
                            <p><strong>Compagnia:</strong> Italiana</p>
                            <p><strong>Min/Max:</strong> ‚Ç¨600 - ‚Ç¨24.000</p>
                            <p><strong>Carichi:</strong> 8% + 2% | <strong>Fee:</strong> 1,75%</p>
                            <p><strong>Rendimento:</strong> 6,5%</p>
                        </div>

                        <div class="compare-card" onclick="toggleProduct(this, 'pac3a')">
                            <input type="checkbox" id="pac3a-check">
                            <h4>üìä Allianz Basso Rischio</h4>
                            <p><strong>Compagnia:</strong> Allianz</p>
                            <p><strong>Min/Max:</strong> ‚Ç¨1.000 - ‚Ç¨6.000</p>
                            <p><strong>Carichi:</strong> 4,15% | <strong>Fee:</strong> 1,75%</p>
                            <p><strong>Rendimento:</strong> 3%</p>
                        </div>

                        <div class="compare-card" onclick="toggleProduct(this, 'pac3b')">
                            <input type="checkbox" id="pac3b-check">
                            <h4>‚öñÔ∏è Allianz Medio Rischio</h4>
                            <p><strong>Compagnia:</strong> Allianz</p>
                            <p><strong>Min/Max:</strong> ‚Ç¨1.000 - ‚Ç¨6.000</p>
                            <p><strong>Carichi:</strong> 4,15% | <strong>Fee:</strong> 1,75%</p>
                            <p><strong>Rendimento:</strong> 5%</p>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>2Ô∏è‚É£ Parametri Simulazione</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="pac-versamento">Versamento Annuale (‚Ç¨):</label>
                            <input type="number" id="pac-versamento" value="5000" min="600" max="24000">
                        </div>
                        <div class="form-group">
                            <label for="pac-durata">Durata (anni):</label>
                            <select id="pac-durata">
                                <option value="5">5 anni</option>
                                <option value="10">10 anni</option>
                                <option value="15">15 anni</option>
                                <option value="20" selected>20 anni</option>
                                <option value="25">25 anni</option>
                                <option value="30">30 anni</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pac-capitale">Capitale Iniziale (‚Ç¨):</label>
                            <input type="number" id="pac-capitale" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="pac-eta">Et√† Sottoscrittore:</label>
                            <input type="number" id="pac-eta" value="40" min="18" max="68">
                        </div>
                    </div>
                </div>

                <div id="pac-results" style="display: none;">
                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üìà Risultati Simulazione</h3>
                        <div id="pac-results-grid" class="results-grid"></div>
                    </div>

                    <div class="chart-container">
                        <canvas id="pacChart"></canvas>
                    </div>

                    <div class="table-container">
                        <table id="pac-table">
                            <thead>
                                <tr>
                                    <th>Prodotto</th>
                                    <th>Anno</th>
                                    <th>Capitale Versato (‚Ç¨)</th>
                                    <th>Rendimenti (‚Ç¨)</th>
                                    <th>Costi Totali (‚Ç¨)</th>
                                    <th>Montante Netto (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div style="background: #E3F2FD; border-left: 4px solid #4285F4; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #0066CC; margin-bottom: 10px;">‚òÅÔ∏è Esporta Risultati</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="exportToCSV('pac')">üì• CSV (Excel)</button>
                            <button class="export-btn" onclick="exportToJSON('pac')">üìã JSON</button>
                        </div>
                    </div>
                </div>

                <div class="buttons-group">
                    <button class="btn" onclick="simulatePAC()">üöÄ Simula PAC</button>
                    <button class="btn-secondary" onclick="resetPAC()">üîÑ Ripristina</button>
                </div>
            </div>

            <!-- TAB 2: TFR -->
            <div id="tab-tfr" class="tab-content">
                <div class="product-description">
                    <h4>üí∞ Simulatore TFR - Confronto Scenari</h4>
                    <p>Calcola il TFR (Trattamento di Fine Rapporto) e confronta diversi scenari di investimento.</p>
                </div>

                <div class="form-section">
                    <h3>1Ô∏è‚É£ Parametri TFR</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tfr-stipendio">Stipendio Annuale (‚Ç¨):</label>
                            <input type="number" id="tfr-stipendio" value="35000" min="15000" max="200000">
                        </div>
                        <div class="form-group">
                            <label for="tfr-anni">Anni Anzianit√†:</label>
                            <input type="number" id="tfr-anni" value="15" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label for="tfr-rivalutazione">Rivalutazione ISTAT (%/anno):</label>
                            <input type="number" id="tfr-rivalutazione" value="1.5" min="0" max="5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="tfr-tassazione">Aliquota Tassazione (%):</label>
                            <input type="number" id="tfr-tassazione" value="12" min="0" max="50">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>2Ô∏è‚É£ Scenari di Investimento</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tfr-scenario">Tipologia Investimento:</label>
                            <select id="tfr-scenario">
                                <option value="conservativo">üìä Conservativo (2,5%)</option>
                                <option value="equilibrato" selected>‚öñÔ∏è Equilibrato (4,5%)</option>
                                <option value="dinamico">üìà Dinamico (6,5%)</option>
                                <option value="vittoria">üèÜ Vittoria Valore (4%)</option>
                                <option value="allianz">üéØ Allianz Bilanciato (5%)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tfr-durata">Periodo Simulazione (anni):</label>
                            <select id="tfr-durata">
                                <option value="10">10 anni</option>
                                <option value="15" selected>15 anni</option>
                                <option value="20">20 anni</option>
                                <option value="30">30 anni</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="tfr-results" style="display: none;">
                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üìä Risultati TFR</h3>
                        <div id="tfr-results-grid" class="results-grid"></div>
                    </div>

                    <div class="chart-container">
                        <canvas id="tfrChart"></canvas>
                    </div>

                    <div class="table-container">
                        <table id="tfr-table">
                            <thead>
                                <tr>
                                    <th>Anno</th>
                                    <th>Capitale Versato (‚Ç¨)</th>
                                    <th>Rendimenti (‚Ç¨)</th>
                                    <th>Costi Totali (‚Ç¨)</th>
                                    <th>Montante Netto (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div style="background: #E3F2FD; border-left: 4px solid #4285F4; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #0066CC; margin-bottom: 10px;">‚òÅÔ∏è Esporta Risultati</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="exportToCSV('tfr')">üì• CSV (Excel)</button>
                            <button class="export-btn" onclick="exportToJSON('tfr')">üìã JSON</button>
                        </div>
                    </div>
                </div>

                <div class="buttons-group">
                    <button class="btn" onclick="simulateTFR()">üöÄ Simula TFR</button>
                    <button class="btn-secondary" onclick="resetTFR()">üîÑ Ripristina</button>
                </div>
            </div>

            <!-- TAB 3: INVESTIMENTI -->
            <div id="tab-investimenti" class="tab-content">
                <div class="product-description">
                    <h4>üíº Simulatore Investimenti - Confronto Profili</h4>
                    <p>Simula gli investimenti con diversi profili di rischio e confronta i rendimenti nel tempo.</p>
                </div>

                <div class="form-section">
                    <h3>1Ô∏è‚É£ Parametri Investimento</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="inv-capitale">Capitale Iniziale (‚Ç¨):</label>
                            <input type="number" id="inv-capitale" value="50000" min="1000" max="1000000">
                        </div>
                        <div class="form-group">
                            <label for="inv-versamento">Versamento Mensile (‚Ç¨):</label>
                            <input type="number" id="inv-versamento" value="500" min="0" max="50000">
                        </div>
                        <div class="form-group">
                            <label for="inv-durata">Durata (anni):</label>
                            <select id="inv-durata">
                                <option value="5">5 anni</option>
                                <option value="10">10 anni</option>
                                <option value="15">15 anni</option>
                                <option value="20" selected>20 anni</option>
                                <option value="25">25 anni</option>
                                <option value="30">30 anni</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inv-tassazione">Aliquota Tassazione (%/anno):</label>
                            <input type="number" id="inv-tassazione" value="26" min="0" max="50">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>2Ô∏è‚É£ Seleziona Profili di Investimento</h3>
                    <div class="compare-section">
                        <div class="compare-card" onclick="toggleInvestment(this, 'conservativo')">
                            <input type="checkbox" id="inv-conservativo-check">
                            <h4>üìä Conservativo</h4>
                            <p><strong>Profilo:</strong> Basso Rischio</p>
                            <p><strong>Allocation:</strong> 20% Azioni / 80% Obbligazioni</p>
                            <p><strong>Rendimento:</strong> 2,5% annuo</p>
                            <p><strong>Volatilit√†:</strong> Bassa</p>
                        </div>

                        <div class="compare-card" onclick="toggleInvestment(this, 'equilibrato')">
                            <input type="checkbox" id="inv-equilibrato-check">
                            <h4>‚öñÔ∏è Equilibrato</h4>
                            <p><strong>Profilo:</strong> Medio Rischio</p>
                            <p><strong>Allocation:</strong> 50% Azioni / 50% Obbligazioni</p>
                            <p><strong>Rendimento:</strong> 4,5% annuo</p>
                            <p><strong>Volatilit√†:</strong> Media</p>
                        </div>

                        <div class="compare-card" onclick="toggleInvestment(this, 'dinamico')">
                            <input type="checkbox" id="inv-dinamico-check">
                            <h4>üìà Dinamico</h4>
                            <p><strong>Profilo:</strong> Alto Rischio</p>
                            <p><strong>Allocation:</strong> 80% Azioni / 20% Obbligazioni</p>
                            <p><strong>Rendimento:</strong> 6,5% annuo</p>
                            <p><strong>Volatilit√†:</strong> Alta</p>
                        </div>

                        <div class="compare-card" onclick="toggleInvestment(this, 'aggressivo')">
                            <input type="checkbox" id="inv-aggressivo-check">
                            <h4>üöÄ Aggressivo</h4>
                            <p><strong>Profilo:</strong> Molto Alto Rischio</p>
                            <p><strong>Allocation:</strong> 100% Azioni</p>
                            <p><strong>Rendimento:</strong> 8,5% annuo</p>
                            <p><strong>Volatilit√†:</strong> Molto Alta</p>
                        </div>
                    </div>
                </div>

                <div id="investimenti-results" style="display: none;">
                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üìä Risultati Investimenti</h3>
                        <div id="investimenti-results-grid" class="results-grid"></div>
                    </div>

                    <div class="chart-container">
                        <canvas id="investiChart"></canvas>
                    </div>

                    <div class="table-container">
                        <table id="investimenti-table">
                            <thead>
                                <tr>
                                    <th>Profilo</th>
                                    <th>Anno</th>
                                    <th>Capitale Versato (‚Ç¨)</th>
                                    <th>Rendimenti (‚Ç¨)</th>
                                    <th>Costi Totali (‚Ç¨)</th>
                                    <th>Montante Netto (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div style="background: #E3F2FD; border-left: 4px solid #4285F4; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #0066CC; margin-bottom: 10px;">‚òÅÔ∏è Esporta Risultati</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="exportToCSV('investimenti')">üì• CSV (Excel)</button>
                            <button class="export-btn" onclick="exportToJSON('investimenti')">üìã JSON</button>
                        </div>
                    </div>
                </div>

                <div class="buttons-group">
                    <button class="btn" onclick="simulateInvestimenti()">üöÄ Simula Investimenti</button>
                    <button class="btn-secondary" onclick="resetInvestimenti()">üîÑ Ripristina</button>
                </div>
            </div>

            <!-- TAB 4: TOP 3 PRODOTTI -->
            <div id="tab-top3" class="tab-content">
                <div class="product-description">
                    <h4>üèÜ Top 3 Prodotti - Ranking Automatico</h4>
                    <p>Confronto rapido dei 3 migliori prodotti disponibili in base ai parametri di simulazione.</p>
                </div>

                <div class="form-section">
                    <h3>1Ô∏è‚É£ Configurazione Ranking</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="top3-versamento">Versamento Annuale (‚Ç¨):</label>
                            <input type="number" id="top3-versamento" value="5000" min="600" max="24000">
                        </div>
                        <div class="form-group">
                            <label for="top3-durata">Durata (anni):</label>
                            <select id="top3-durata">
                                <option value="5">5 anni</option>
                                <option value="10">10 anni</option>
                                <option value="15">15 anni</option>
                                <option value="20" selected>20 anni</option>
                                <option value="25">25 anni</option>
                                <option value="30">30 anni</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="top3-capitale">Capitale Iniziale (‚Ç¨):</label>
                            <input type="number" id="top3-capitale" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="top3-irpef">Aliquota IRPEF (%):</label>
                            <input type="number" id="top3-irpef" value="23" min="0" max="43">
                        </div>
                    </div>
                </div>

                <div id="top3-results" style="display: none;">
                    <div class="results-section">
                        <h3 style="margin-bottom: 20px; color: var(--primary);">ü•áü•àü•â Top 3 Ranking Prodotti</h3>
                        <div id="top3-ranking" style="display: grid; gap: 20px;"></div>
                    </div>

                    <div class="chart-container">
                        <canvas id="top3Chart"></canvas>
                    </div>

                    <div class="table-container">
                        <table id="top3-table">
                            <thead>
                                <tr>
                                    <th>Posizione</th>
                                    <th>Prodotto</th>
                                    <th>Compagnia</th>
                                    <th>Montante Lordo (‚Ç¨)</th>
                                    <th>Tasse (‚Ç¨)</th>
                                    <th>Montante Netto (‚Ç¨)</th>
                                    <th>Rendimento Netto %</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div style="background: #E3F2FD; border-left: 4px solid #4285F4; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #0066CC; margin-bottom: 10px;">‚òÅÔ∏è Esporta Risultati</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="exportTop3CSV()">üì• CSV (Excel)</button>
                            <button class="export-btn" onclick="exportTop3JSON()">üìã JSON</button>
                        </div>
                    </div>
                </div>

                <div class="buttons-group">
                    <button class="btn" onclick="simulateTop3()">üöÄ Genera Ranking</button>
                    <button class="btn-secondary" onclick="resetTop3()">üîÑ Ripristina</button>
                </div>
            </div>

            <!-- TAB 5: ANALISI AVANZATA -->
            <div id="tab-analisi" class="tab-content">
                <div class="product-description">
                    <h4>üî¨ Analisi Avanzata - Strumenti Professionali</h4>
                    <p>Rapporto di confronto automatico, break-even analysis, inflazione, fiscalit√† e benchmarking vs mercato.</p>
                </div>

                <div class="form-section">
                    <h3>üìä 1Ô∏è‚É£ Seleziona Prodotti per Analisi</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="analisi-prodotto1">Prodotto 1:</label>
                            <select id="analisi-prodotto1">
                                <option value="pac1">PAC Valore Futuro (Vittoria)</option>
                                <option value="pac2a">PAC Forza Bilanciata (Italiana)</option>
                                <option value="pac2b">PAC Forza Aggressiva (Italiana)</option>
                                <option value="pac3a">PAC Goal Basso Rischio (Allianz)</option>
                                <option value="pac3b">PAC Goal Medio Rischio (Allianz)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="analisi-prodotto2">Prodotto 2 (Confronto):</label>
                            <select id="analisi-prodotto2">
                                <option value="pac1">PAC Valore Futuro (Vittoria)</option>
                                <option value="pac2a" selected>PAC Forza Bilanciata (Italiana)</option>
                                <option value="pac2b">PAC Forza Aggressiva (Italiana)</option>
                                <option value="pac3a">PAC Goal Basso Rischio (Allianz)</option>
                                <option value="pac3b">PAC Goal Medio Rischio (Allianz)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="analisi-versamento">Versamento Annuale (‚Ç¨):</label>
                            <input type="number" id="analisi-versamento" value="5000" min="600">
                        </div>
                        <div class="form-group">
                            <label for="analisi-durata-analisi">Durata (anni):</label>
                            <select id="analisi-durata-analisi">
                                <option value="5">5 anni</option>
                                <option value="10">10 anni</option>
                                <option value="15">15 anni</option>
                                <option value="20" selected>20 anni</option>
                                <option value="25">25 anni</option>
                                <option value="30">30 anni</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="analisi-inflazione">Inflazione Annua (%):</label>
                            <input type="number" id="analisi-inflazione" value="2" min="0" max="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="analisi-irpef">Aliquota IRPEF (%):</label>
                            <input type="number" id="analisi-irpef" value="23" min="0" max="43">
                        </div>
                    </div>
                </div>

                <div id="analisi-results" style="display: none;">
                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üèÜ Ranking Prodotti</h3>
                        <div id="analisi-ranking" style="display: grid; gap: 10px;"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <div class="chart-container">
                            <canvas id="torteChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="waterfall"></canvas>
                        </div>
                    </div>

                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üìà Break-Even Analysis</h3>
                        <div id="analisi-breakeven" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;"></div>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="breakevenChart"></canvas>
                        </div>
                    </div>

                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üìâ Inflazione & Potenza d'Acquisto</h3>
                        <div id="analisi-inflazione-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;"></div>
                    </div>

                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üí∞ Stima Fiscale Dettagliata</h3>
                        <div class="table-container">
                            <table id="analisi-fiscal-table">
                                <thead>
                                    <tr>
                                        <th>Prodotto</th>
                                        <th>Montante Lordo (‚Ç¨)</th>
                                        <th>Guadagno (‚Ç¨)</th>
                                        <th>IRPEF (‚Ç¨)</th>
                                        <th>Montante Netto (‚Ç¨)</th>
                                        <th>Rendimento Netto %</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="results-section">
                        <h3 style="margin-bottom: 15px; color: var(--primary);">üìä Benchmarking vs Indici Mercato</h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="benchmarkChart"></canvas>
                        </div>
                        <div style="margin-top: 15px; font-size: 12px; color: var(--text-light);">
                            <p>üîπ <strong>EURIBOR 12M:</strong> Tasso interbancario di riferimento europeo</p>
                            <p>üîπ <strong>BTP 10Y:</strong> Rendimento medio dei titoli di stato italiani a 10 anni</p>
                            <p>üîπ <strong>MSCI World:</strong> Indice azionario globale</p>
                            <p>üîπ <strong>Inflazione Media:</strong> Variazione generale dei prezzi al consumo</p>
                        </div>
                    </div>

                    <div style="background: #E3F2FD; border-left: 4px solid #4285F4; padding: 20px; border-radius: 8px; margin-top: 25px;">
                        <h4 style="color: #0066CC; margin-bottom: 15px;">üìã Genera Report Professionale</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="export-btn" onclick="generatePDFReport()">üìÑ Report PDF Completo</button>
                            <button class="export-btn" onclick="exportAnalisiCSV()">üìä Esporta CSV</button>
                            <button class="export-btn" onclick="exportAnalisiJSON()">üìã Esporta JSON</button>
                        </div>
                    </div>
                </div>

                <div class="buttons-group">
                    <button class="btn" onclick="simulateAnalisi()">üöÄ Avvia Analisi</button>
                    <button class="btn-secondary" onclick="resetAnalisi()">üîÑ Ripristina</button>
                </div>
            </div>

            <!-- TAB 6: INFO -->
            <div id="tab-info" class="tab-content">
                <div class="product-description">
                    <h4>üìö Informazioni Prodotti</h4>
                    <p><strong>‚ö†Ô∏è ESCLUSIVAMENTE AD USO INTERNO</strong> ‚Ä¢ Dati aggiornati al 31/10/2025 ‚Ä¢ Non diffondere su social network</p>
                </div>

                <div class="form-section">
                    <h3>üèÜ Vittoria - PAC Valore Futuro</h3>
                    <ul style="margin-left: 20px; line-height: 1.8; font-size: 13px;">
                        <li><strong>Allocation:</strong> 20% GS Obiettivo Valore + 80% Azionario Europa</li>
                        <li><strong>Premio Annuale:</strong> ‚Ç¨1.800 - ‚Ç¨12.000</li>
                        <li><strong>Carichi:</strong> 5% su premi ricorrenti</li>
                        <li><strong>Commissioni:</strong> 1,20% + 2%</li>
                        <li><strong>Rendimento 5 anni:</strong> 3,68% (media al 31/10/2025)</li>
                        <li><strong>Riscatto:</strong> Dopo 3 anni</li>
                    </ul>
                </div>

                <div class="form-section">
                    <h3>üáÆüáπ Italiana - PAC Risparmio & Investimento+</h3>
                    <ul style="margin-left: 20px; line-height: 1.8; font-size: 13px;">
                        <li><strong>Linee:</strong> Forza Bilanciata (4,5%) o Forza Aggressiva (6,5%)</li>
                        <li><strong>Premio Annuale:</strong> ‚Ç¨600 - ‚Ç¨24.000</li>
                        <li><strong>Carichi:</strong> 8% ricorrenti + 2% aggiuntivi</li>
                        <li><strong>Commissioni:</strong> 1,50% - 2%</li>
                        <li><strong>Riscatto:</strong> Dopo 12 mesi</li>
                    </ul>
                </div>

                <div class="form-section">
                    <h3>üéØ Allianz - PAC Goal Driven Plan</h3>
                    <ul style="margin-left: 20px; line-height: 1.8; font-size: 13px;">
                        <li><strong>Profili:</strong> Basso (3%) o Medio (5%) Rischio</li>
                        <li><strong>Premio Annuale:</strong> ‚Ç¨1.000 - ‚Ç¨6.000</li>
                        <li><strong>Carichi:</strong> 4,15% x anni durata</li>
                        <li><strong>Commissioni:</strong> 1,75%</li>
                        <li><strong>Riscatto:</strong> In qualsiasi momento</li>
                    </ul>
                </div>

                <div class="form-section">
                    <h3>‚öñÔ∏è Disclaimer Legale</h3>
                    <div class="alert alert-danger">
                        ‚ö†Ô∏è <strong>USO INTERNO ESCLUSIVO:</strong> Non diffondere su social o a terzi non autorizzati.
                    </div>
                    <div class="alert alert-warning">
                        üìä <strong>DATI AL 31/10/2025:</strong> I rendimenti sono storici. La performance passata non garantisce risultati futuri.
                    </div>
                    <div class="alert alert-info">
                        üíº <strong>NON √à CONSULENZA:</strong> Consultare sempre i prospetti ufficiali dei prodotti.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== DATI PRODOTTI =====
        const prodotti = {
            pac1: {
                nome: 'PAC Valore Futuro',
                compagnia: 'Vittoria',
                carichi: 0.05,
                fees: 0.032,
                rendimento: 0.04,
                minAnnuale: 1800,
                maxAnnuale: 12000
            },
            pac2a: {
                nome: 'PAC Forza Bilanciata',
                compagnia: 'Italiana',
                carichi: 0.08,
                feesAggiuntivi: 0.02,
                fees: 0.0175,
                rendimento: 0.045,
                minAnnuale: 600,
                maxAnnuale: 24000
            },
            pac2b: {
                nome: 'PAC Forza Aggressiva',
                compagnia: 'Italiana',
                carichi: 0.08,
                feesAggiuntivi: 0.02,
                fees: 0.0175,
                rendimento: 0.065,
                minAnnuale: 600,
                maxAnnuale: 24000
            },
            pac3a: {
                nome: 'PAC Goal Basso Rischio',
                compagnia: 'Allianz',
                carichi: 0.0415,
                feesAggiuntivi: 0.02,
                fees: 0.0175,
                rendimento: 0.03,
                minAnnuale: 1000,
                maxAnnuale: 6000
            },
            pac3b: {
                nome: 'PAC Goal Medio Rischio',
                compagnia: 'Allianz',
                carichi: 0.0415,
                feesAggiuntivi: 0.02,
                fees: 0.0175,
                rendimento: 0.05,
                minAnnuale: 1000,
                maxAnnuale: 6000
            }
        };

        const investimenti = {
            conservativo: {
                nome: 'Conservativo',
                rendimento: 0.025,
                rischio: 'Basso'
            },
            equilibrato: {
                nome: 'Equilibrato',
                rendimento: 0.045,
                rischio: 'Medio'
            },
            dinamico: {
                nome: 'Dinamico',
                rendimento: 0.065,
                rischio: 'Alto'
            },
            aggressivo: {
                nome: 'Aggressivo',
                rendimento: 0.085,
                rischio: 'Molto Alto'
            }
        };

        const users = {
            'Patrizia': 'VitaNuova2025',
            'Gianluca': 'VitaNuova2025',
            'Pippo': 'VitaNuova2025',
            'Francesca': 'VitaNuova2025'
        };

        let currentUser = null;
        let selectedProdotti = [];
        let selectedInvestimenti = [];
        let pacChart = null;
        let tfrChart = null;
        let investiChart = null;
        let top3Chart = null;

        // ===== LOGIN =====
        function selectUser(btn, user) {
            document.querySelectorAll('.user-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            currentUser = user;
        }

        function login() {
            if (!currentUser) {
                alert('Seleziona un utente');
                return;
            }
            const pwd = document.getElementById('pwd').value;
            if (pwd !== users[currentUser]) {
                alert('Password non corretta');
                return;
            }
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userName').textContent = currentUser;
            localStorage.setItem('currentUser', currentUser);
        }

        function logout() {
            currentUser = null;
            selectedProdotti = [];
            selectedInvestimenti = [];
            localStorage.removeItem('currentUser');
            document.getElementById('login').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
            document.getElementById('pwd').value = '';
            resetPAC();
            resetTFR();
            resetInvestimenti();
        }

        // ===== TAB NAVIGATION =====
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // ===== PAC FUNCTIONS =====
        function toggleProduct(card, productId) {
            card.classList.toggle('selected');
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                if (!selectedProdotti.includes(productId)) {
                    selectedProdotti.push(productId);
                }
            } else {
                selectedProdotti = selectedProdotti.filter(p => p !== productId);
            }
        }

        function simulatePAC() {
            const versamento = parseFloat(document.getElementById('pac-versamento').value);
            const durata = parseInt(document.getElementById('pac-durata').value);
            const capitale = parseFloat(document.getElementById('pac-capitale').value);

            if (selectedProdotti.length === 0) {
                alert('Seleziona almeno un prodotto');
                return;
            }

            for (let prodId of selectedProdotti) {
                const prod = prodotti[prodId];
                if (versamento < prod.minAnnuale || versamento > prod.maxAnnuale) {
                    alert(`${prod.nome}: versamento tra ‚Ç¨${prod.minAnnuale} e ‚Ç¨${prod.maxAnnuale}`);
                    return;
                }
            }

            const results = {};
            for (let prodId of selectedProdotti) {
                const prod = prodotti[prodId];
                let montante = capitale;
                let totalVersamenti = capitale;
                let totalCosti = 0;
                const lineaData = [];

                for (let anno = 1; anno <= durata; anno++) {
                    montante += versamento;
                    totalVersamenti += versamento;

                    const rendimenti = montante * prod.rendimento;
                    montante += rendimenti;

                    const carico = versamento * prod.carichi;
                    const commissioni = montante * prod.fees;
                    const costiAnnuali = carico + commissioni;
                    totalCosti += costiAnnuali;

                    montante -= costiAnnuali;

                    if (anno % 5 === 0 || anno === durata) {
                        lineaData.push({
                            anno: anno,
                            capitaleVersato: totalVersamenti.toFixed(2),
                            rendimenti: (montante - (totalVersamenti - totalCosti)).toFixed(2),
                            costiTotali: totalCosti.toFixed(2),
                            montanteNetto: montante.toFixed(2)
                        });
                    }
                }

                results[prodId] = {
                    montanteFinale: montante.toFixed(2),
                    data: lineaData
                };
            }

            displayPACResults(results, durata);
        }

        function displayPACResults(results, durata) {
            const resultsGrid = document.getElementById('pac-results-grid');
            resultsGrid.innerHTML = '';

            let idx = 0;
            for (let prodId in results) {
                const result = results[prodId];
                const prod = prodotti[prodId];
                const div = document.createElement('div');
                div.className = 'result-card' + (idx === 0 ? ' primary' : '');
                div.innerHTML = `
                    <div class="result-label">${prod.nome}</div>
                    <div class="result-value">‚Ç¨${parseFloat(result.montanteFinale).toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                    <div style="font-size: 11px; margin-top: 5px; color: var(--text-light);">Dopo ${durata} anni</div>
                `;
                resultsGrid.appendChild(div);
                idx++;
            }

            const labels = [];
            const datasets = [];
            let colorIdx = 0;
            const colors = ['#FF2D55', '#0066CC', '#28A745'];

            for (let prodId in results) {
                const result = results[prodId];
                const prod = prodotti[prodId];
                const values = result.data.map(d => parseFloat(d.montanteNetto));
                const anni = result.data.map(d => d.anno);

                if (labels.length === 0) labels.push(...anni);

                datasets.push({
                    label: prod.nome,
                    data: values,
                    borderColor: colors[colorIdx % colors.length],
                    backgroundColor: colors[colorIdx % colors.length] + '20',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: colors[colorIdx % colors.length]
                });

                colorIdx++;
            }

            if (pacChart) pacChart.destroy();
            const ctx = document.getElementById('pacChart').getContext('2d');
            pacChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Evoluzione Montante PAC' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const tbody = document.querySelector('#pac-table tbody');
            tbody.innerHTML = '';
            for (let prodId in results) {
                const result = results[prodId];
                const prod = prodotti[prodId];
                for (let row of result.data) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${prod.nome}</td>
                        <td>${row.anno}</td>
                        <td>‚Ç¨${parseFloat(row.capitaleVersato).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td>‚Ç¨${parseFloat(row.rendimenti).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td>‚Ç¨${parseFloat(row.costiTotali).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td>‚Ç¨${parseFloat(row.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }

            document.getElementById('pac-results').style.display = 'block';
        }

        function resetPAC() {
            selectedProdotti = [];
            document.querySelectorAll('#tab-pac .compare-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('#tab-pac .compare-card input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('pac-results').style.display = 'none';
            if (pacChart) pacChart.destroy();
        }

        // ===== TFR FUNCTIONS =====
        function simulateTFR() {
            const stipendio = parseFloat(document.getElementById('tfr-stipendio').value);
            const anni = parseInt(document.getElementById('tfr-anni').value);
            const rivalutazione = parseFloat(document.getElementById('tfr-rivalutazione').value) / 100;
            const tassazione = parseFloat(document.getElementById('tfr-tassazione').value) / 100;
            const scenario = document.getElementById('tfr-scenario').value;
            const durata = parseInt(document.getElementById('tfr-durata').value);

            const scenariRendimenti = {
                'conservativo': 0.025,
                'equilibrato': 0.045,
                'dinamico': 0.065,
                'vittoria': 0.04,
                'allianz': 0.050
            };

            const rendimento = scenariRendimenti[scenario];

            let tfrAccumulato = 0;
            const tableData = [];

            for (let anno = 1; anno <= durata; anno++) {
                tfrAccumulato += (stipendio * 13.5) / 12;
                tfrAccumulato *= (1 + rivalutazione);

                const rendimentoInvestimento = tfrAccumulato * rendimento;
                const tasse = rendimentoInvestimento * tassazione;
                const montanteNetto = tfrAccumulato + rendimentoInvestimento - tasse;

                if (anno % 5 === 0 || anno === durata) {
                    tableData.push({
                        anno: anno,
                        capitaleVersato: (tfrAccumulato / (1 + rendimento)).toFixed(2),
                        rendimenti: rendimentoInvestimento.toFixed(2),
                        costiTotali: tasse.toFixed(2),
                        montanteNetto: montanteNetto.toFixed(2)
                    });
                }
            }

            displayTFRResults(tableData, scenario, durata);
        }

        function displayTFRResults(tableData, scenario, durata) {
            const resultsGrid = document.getElementById('tfr-results-grid');
            resultsGrid.innerHTML = '';

            const finalData = tableData[tableData.length - 1];
            const div = document.createElement('div');
            div.className = 'result-card primary';
            div.innerHTML = `
                <div class="result-label">TFR Netto</div>
                <div class="result-value">‚Ç¨${parseFloat(finalData.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                <div style="font-size: 11px; margin-top: 5px; color: var(--text-light);">Dopo ${durata} anni</div>
            `;
            resultsGrid.appendChild(div);

            const labels = tableData.map(d => `Anno ${d.anno}`);
            const netti = tableData.map(d => parseFloat(d.montanteNetto));

            if (tfrChart) tfrChart.destroy();
            const ctx = document.getElementById('tfrChart').getContext('2d');
            tfrChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'TFR Netto',
                            data: netti,
                            borderColor: '#FF2D55',
                            backgroundColor: '#FF2D5520',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const tbody = document.querySelector('#tfr-table tbody');
            tbody.innerHTML = '';
            for (let row of tableData) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.anno}</td>
                    <td>‚Ç¨${parseFloat(row.capitaleVersato).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${parseFloat(row.rendimenti).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${parseFloat(row.costiTotali).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${parseFloat(row.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('tfr-results').style.display = 'block';
        }

        function resetTFR() {
            document.getElementById('tfr-results').style.display = 'none';
            if (tfrChart) tfrChart.destroy();
        }

        // ===== INVESTIMENTI FUNCTIONS =====
        function toggleInvestment(card, investId) {
            card.classList.toggle('selected');
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                if (!selectedInvestimenti.includes(investId)) {
                    selectedInvestimenti.push(investId);
                }
            } else {
                selectedInvestimenti = selectedInvestimenti.filter(i => i !== investId);
            }
        }

        function simulateInvestimenti() {
            const capitale = parseFloat(document.getElementById('inv-capitale').value);
            const versamento = parseFloat(document.getElementById('inv-versamento').value);
            const durata = parseInt(document.getElementById('inv-durata').value);
            const tassazione = parseFloat(document.getElementById('inv-tassazione').value) / 100;

            if (selectedInvestimenti.length === 0) {
                alert('Seleziona almeno un profilo di investimento');
                return;
            }

            const results = {};
            for (let invId of selectedInvestimenti) {
                const inv = investimenti[invId];
                let montante = capitale;
                let totalVersamenti = capitale;
                let totalCosti = 0;
                const lineaData = [];

                for (let anno = 1; anno <= durata; anno++) {
                    const versamentiAnnuali = versamento * 12;
                    montante += versamentiAnnuali;
                    totalVersamenti += versamentiAnnuali;

                    const rendimenti = montante * inv.rendimento;
                    const tasse = rendimenti * tassazione;
                    totalCosti += tasse;
                    montante += rendimenti - tasse;

                    if (anno % 5 === 0 || anno === durata) {
                        lineaData.push({
                            anno: anno,
                            capitaleVersato: totalVersamenti.toFixed(2),
                            rendimenti: rendimenti.toFixed(2),
                            costiTotali: totalCosti.toFixed(2),
                            montanteNetto: montante.toFixed(2)
                        });
                    }
                }

                results[invId] = {
                    montanteFinale: montante.toFixed(2),
                    data: lineaData
                };
            }

            displayInvestiResults(results, durata);
        }

        function displayInvestiResults(results, durata) {
            const resultsGrid = document.getElementById('investimenti-results-grid');
            resultsGrid.innerHTML = '';

            let idx = 0;
            for (let invId in results) {
                const result = results[invId];
                const inv = investimenti[invId];
                const div = document.createElement('div');
                div.className = 'result-card' + (idx === 0 ? ' primary' : '');
                div.innerHTML = `
                    <div class="result-label">${inv.nome} (${inv.rischio})</div>
                    <div class="result-value">‚Ç¨${parseFloat(result.montanteFinale).toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                    <div style="font-size: 11px; margin-top: 5px; color: var(--text-light);">Dopo ${durata} anni</div>
                `;
                resultsGrid.appendChild(div);
                idx++;
            }

            const labels = [];
            const datasets = [];
            let colorIdx = 0;
            const colors = ['#28A745', '#0066CC', '#FF2D55', '#FF8C00'];

            for (let invId in results) {
                const result = results[invId];
                const inv = investimenti[invId];
                const values = result.data.map(d => parseFloat(d.montanteNetto));
                const anni = result.data.map(d => d.anno);

                if (labels.length === 0) labels.push(...anni);

                datasets.push({
                    label: inv.nome,
                    data: values,
                    borderColor: colors[colorIdx % colors.length],
                    backgroundColor: colors[colorIdx % colors.length] + '20',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: colors[colorIdx % colors.length]
                });

                colorIdx++;
            }

            if (investiChart) investiChart.destroy();
            const ctx = document.getElementById('investiChart').getContext('2d');
            investiChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Evoluzione Investimenti - Confronto Profili' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const tbody = document.querySelector('#investimenti-table tbody');
            tbody.innerHTML = '';
            for (let invId in results) {
                const result = results[invId];
                const inv = investimenti[invId];
                for (let row of result.data) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${inv.nome}</td>
                        <td>${row.anno}</td>
                        <td>‚Ç¨${parseFloat(row.capitaleVersato).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td>‚Ç¨${parseFloat(row.rendimenti).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td>‚Ç¨${parseFloat(row.costiTotali).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td>‚Ç¨${parseFloat(row.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }

            document.getElementById('investimenti-results').style.display = 'block';
        }

        function resetInvestimenti() {
            selectedInvestimenti = [];
            document.querySelectorAll('#tab-investimenti .compare-card').forEach(card => card.classList.remove('selected'));
            document.querySelectorAll('#tab-investimenti .compare-card input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('investimenti-results').style.display = 'none';
            if (investiChart) investiChart.destroy();
        }

        // ===== TOP 3 FUNCTIONS =====
        function simulateTop3() {
            const versamento = parseFloat(document.getElementById('top3-versamento').value);
            const durata = parseInt(document.getElementById('top3-durata').value);
            const capitale = parseFloat(document.getElementById('top3-capitale').value);
            const irpef = parseFloat(document.getElementById('top3-irpef').value) / 100;

            const allProdotti = Object.keys(prodotti).map(key => ({
                id: key,
                ...prodotti[key]
            }));

            const results = [];
            for (let prod of allProdotti) {
                let montante = capitale;
                let totalVersamenti = capitale;
                let totalCosti = 0;

                for (let anno = 1; anno <= durata; anno++) {
                    montante += versamento;
                    totalVersamenti += versamento;

                    const rendimenti = montante * prod.rendimento;
                    montante += rendimenti;

                    const carico = versamento * prod.carichi;
                    const commissioni = montante * prod.fees;
                    const costiAnnuali = carico + commissioni;
                    totalCosti += costiAnnuali;

                    montante -= costiAnnuali;
                }

                const guadagno = montante - totalVersamenti;
                const irpefAmount = Math.max(0, guadagno * irpef);
                const montanteNetto = montante - irpefAmount;
                const roiPercent = totalVersamenti > 0 ? ((montanteNetto - totalVersamenti) / totalVersamenti * 100) : 0;

                results.push({
                    nome: prod.nome,
                    compagnia: prod.compagnia,
                    montanteFinale: montante,
                    montanteNetto: montanteNetto,
                    irpef: irpefAmount,
                    roi: roiPercent,
                    guadagno: guadagno,
                    costiTotali: totalCosti,
                    versamenti: totalVersamenti,
                    prod: prod
                });
            }

            results.sort((a, b) => b.montanteNetto - a.montanteNetto);
            const top3 = results.slice(0, 3);

            displayTop3Results(top3, durata);
        }

        function displayTop3Results(top3, durata) {
            const rankingDiv = document.getElementById('top3-ranking');
            rankingDiv.innerHTML = '';

            top3.forEach((item, idx) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const card = document.createElement('div');
                card.style.backgroundColor = idx === 0 ? 'rgba(255, 45, 85, 0.08)' : idx === 1 ? 'rgba(0, 102, 204, 0.08)' : 'rgba(40, 167, 69, 0.08)';
                card.style.borderLeft = `4px solid ${idx === 0 ? '#FF2D55' : idx === 1 ? '#0066CC' : '#28A745'}`;
                card.style.padding = '20px';
                card.style.borderRadius = '8px';
                card.style.marginBottom = '10px';

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: 5px;">
                                ${medals[idx]} POSTO ${idx + 1}
                            </div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--primary); margin-bottom: 8px;">
                                ${item.nome}
                            </div>
                            <div style="font-size: 13px; color: var(--text-light); margin-bottom: 12px;">
                                ${item.compagnia}
                            </div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 5px;">
                                ‚Ç¨${parseFloat(item.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}
                            </div>
                            <div style="font-size: 12px; color: var(--text-light);">
                                ROI: <strong>${item.roi.toFixed(2)}%</strong>
                            </div>
                        </div>
                        <div style="text-align: right; font-size: 12px; line-height: 1.8;">
                            <p style="margin: 5px 0;"><strong>Versamenti:</strong><br>‚Ç¨${parseFloat(item.versamenti).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                            <p style="margin: 5px 0;"><strong>Lordo:</strong><br>‚Ç¨${parseFloat(item.montanteFinale).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                            <p style="margin: 5px 0;"><strong>Tasse:</strong><br>‚Ç¨${parseFloat(item.irpef).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                            <p style="margin: 5px 0; color: var(--success);"><strong>Netto:</strong><br>‚Ç¨${parseFloat(item.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                        </div>
                    </div>
                `;
                rankingDiv.appendChild(card);
            });

            if (top3Chart) top3Chart.destroy();
            const ctx = document.getElementById('top3Chart').getContext('2d');
            top3Chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top3.map(t => t.nome),
                    datasets: [{
                        label: 'Montante Netto (‚Ç¨)',
                        data: top3.map(t => parseFloat(t.montanteNetto)),
                        backgroundColor: ['#FF2D55', '#0066CC', '#28A745'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Top 3 Prodotti - Montante Netto' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });

            const tbody = document.querySelector('#top3-table tbody');
            tbody.innerHTML = '';
            top3.forEach((item, idx) => {
                const tr = document.createElement('tr');
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                tr.innerHTML = `
                    <td style="text-align: center; font-size: 18px;">${medals[idx]}</td>
                    <td><strong>${item.nome}</strong></td>
                    <td>${item.compagnia}</td>
                    <td>‚Ç¨${parseFloat(item.montanteFinale).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${parseFloat(item.irpef).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td style="color: var(--primary); font-weight: 600;">‚Ç¨${parseFloat(item.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td><strong>${item.roi.toFixed(2)}%</strong></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('top3-results').style.display = 'block';
        }

        function exportTop3CSV() {
            let csv = 'TOP 3 PRODOTTI - VitaNuova Simulator Pro\n';
            csv += `Data: ${new Date().toLocaleDateString('it-IT')}\nUtente: ${currentUser}\n\n`;

            const rows = document.querySelector('#top3-table tbody').querySelectorAll('tr');
            csv += 'Posizione,Prodotto,Compagnia,Montante Lordo,Tasse,Montante Netto,ROI %\n';
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                csv += Array.from(cells).map(c => c.textContent).join(',') + '\n';
            });

            downloadFile(csv, 'top3-prodotti.csv', 'text/csv');
        }

        function exportTop3JSON() {
            const rows = document.querySelector('#top3-table tbody').querySelectorAll('tr');
            const data = [];

            rows.forEach((row, idx) => {
                const cells = row.querySelectorAll('td');
                data.push({
                    posizione: idx + 1,
                    prodotto: cells[1].textContent,
                    compagnia: cells[2].textContent,
                    montanteLordo: cells[3].textContent,
                    tasse: cells[4].textContent,
                    montanteNetto: cells[5].textContent,
                    roi: cells[6].textContent
                });
            });

            const json = JSON.stringify({
                date: new Date().toLocaleDateString('it-IT'),
                user: currentUser,
                report: 'Top 3 Prodotti',
                data: data
            }, null, 2);

            downloadFile(json, 'top3-prodotti.json', 'application/json');
        }

        function resetTop3() {
            document.getElementById('top3-results').style.display = 'none';
            if (top3Chart) top3Chart.destroy();
        }

        // ===== ANALISI AVANZATA FUNCTIONS =====
        let torteChartInstance = null;
        let waterfallChartInstance = null;
        let breakevenChartInstance = null;
        let benchmarkChartInstance = null;

        function simulateAnalisi() {
            const prod1Id = document.getElementById('analisi-prodotto1').value;
            const prod2Id = document.getElementById('analisi-prodotto2').value;
            const versamento = parseFloat(document.getElementById('analisi-versamento').value);
            const durata = parseInt(document.getElementById('analisi-durata-analisi').value);
            const inflazione = parseFloat(document.getElementById('analisi-inflazione').value) / 100;
            const irpef = parseFloat(document.getElementById('analisi-irpef').value) / 100;

            const prod1 = prodotti[prod1Id];
            const prod2 = prodotti[prod2Id];

            const results1 = calcolaProdotto(prod1, versamento, durata, inflazione, irpef);
            const results2 = calcolaProdotto(prod2, versamento, durata, inflazione, irpef);

            displayRanking([results1, results2], [prod1, prod2]);
            displayGraficiAvanzati(results1, results2, prod1, prod2, durata);
            displayBreakEvenAnalysis(results1, results2, prod1, prod2, versamento, durata);
            displayInflazioneAnalisi(results1, results2, prod1, prod2, durata, inflazione);
            displayFiscalitaDettagliata(results1, results2, prod1, prod2);
            displayBenchmarking(results1, results2, durata);

            document.getElementById('analisi-results').style.display = 'block';
        }

        function calcolaProdotto(prod, versamento, durata, inflazione, irpef) {
            let montante = 0;
            let totalVersamenti = 0;
            let totalCosti = 0;
            const yearlyData = [];

            for (let anno = 1; anno <= durata; anno++) {
                montante += versamento;
                totalVersamenti += versamento;

                const rendimenti = montante * prod.rendimento;
                montante += rendimenti;

                const carico = versamento * prod.carichi;
                const commissioni = montante * prod.fees;
                const costiAnnuali = carico + commissioni;
                totalCosti += costiAnnuali;

                montante -= costiAnnuali;

                yearlyData.push({
                    anno: anno,
                    montante: montante,
                    rendimenti: rendimenti,
                    costi: costiAnnuali
                });
            }

            const guadagno = montante - totalVersamenti;
            const irpefAmount = Math.max(0, guadagno * irpef);
            const montanteNetto = montante - irpefAmount;
            const rendimentoNettoPercent = totalVersamenti > 0 ? ((montanteNetto - totalVersamenti) / totalVersamenti * 100) : 0;

            return {
                nome: prod.nome,
                montanteFinale: montante,
                montanteNetto: montanteNetto,
                guadagno: guadagno,
                irpef: irpefAmount,
                totalVersamenti: totalVersamenti,
                totalCosti: totalCosti,
                rendimentoNetto: rendimentoNettoPercent,
                yearlyData: yearlyData,
                prod: prod
            };
        }

        function displayRanking(results, prods) {
            const rankingDiv = document.getElementById('analisi-ranking');
            rankingDiv.innerHTML = '';

            results.sort((a, b) => b.montanteNetto - a.montanteNetto);

            results.forEach((r, idx) => {
                const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â';
                const card = document.createElement('div');
                card.className = 'result-card primary';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div class="result-label">${medal} Posizione ${idx + 1}: ${r.nome}</div>
                            <div class="result-value">‚Ç¨${parseFloat(r.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}</div>
                            <div style="font-size: 11px; margin-top: 8px; color: var(--text-light);">
                                Netto ‚Ä¢ ROI: ${r.rendimentoNetto.toFixed(2)}%
                            </div>
                        </div>
                        <div style="text-align: right; font-size: 12px;">
                            <p style="margin: 3px 0;"><strong>Lordo:</strong> ‚Ç¨${parseFloat(r.montanteFinale).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                            <p style="margin: 3px 0;"><strong>Tasse:</strong> ‚Ç¨${parseFloat(r.irpef).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                            <p style="margin: 3px 0;"><strong>Costi:</strong> ‚Ç¨${parseFloat(r.totalCosti).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                        </div>
                    </div>
                `;
                rankingDiv.appendChild(card);
            });
        }

        function displayGraficiAvanzati(results1, results2, prod1, prod2, durata) {
            const ctx1 = document.getElementById('torteChart').getContext('2d');
            if (torteChartInstance) torteChartInstance.destroy();
            torteChartInstance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Capitale Versato', 'Rendimenti Netti', 'Tasse', 'Costi'],
                    datasets: [{
                        data: [
                            results1.totalVersamenti,
                            Math.max(0, results1.guadagno - results1.irpef - results1.totalCosti),
                            results1.irpef,
                            results1.totalCosti
                        ],
                        backgroundColor: ['#0066CC', '#28A745', '#E74C3C', '#FFC107']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: `${results1.nome} - Allocazione Montante` } }
                }
            });

            const waterfallData = [
                { label: 'Versamenti', value: results2.totalVersamenti, color: '#0066CC' },
                { label: 'Rendimenti', value: results2.guadagno - results2.totalCosti - results2.irpef, color: '#28A745' },
                { label: 'Costi', value: -results2.totalCosti, color: '#FFC107' },
                { label: 'Tasse IRPEF', value: -results2.irpef, color: '#E74C3C' }
            ];

            let cumulative = 0;
            const waterfallValues = [];
            const waterfallColors = [];

            waterfallData.forEach(item => {
                waterfallValues.push(cumulative);
                waterfallColors.push(item.color);
                cumulative += item.value;
            });

            const ctx2 = document.getElementById('waterfall').getContext('2d');
            if (waterfallChartInstance) waterfallChartInstance.destroy();
            waterfallChartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: waterfallData.map(d => d.label),
                    datasets: [{
                        label: `${results2.nome} - Waterfall`,
                        data: waterfallData.map(d => d.value),
                        backgroundColor: waterfallColors,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { stacked: false } }
                }
            });
        }

        function displayBreakEvenAnalysis(results1, results2, prod1, prod2, versamento, durata) {
            const breakevenDiv = document.getElementById('analisi-breakeven');
            breakevenDiv.innerHTML = '';

            const calcolaBreakEven = (prod) => {
                let montante = 0;
                for (let y = 1; y <= durata; y++) {
                    montante += versamento;
                    const rendimenti = montante * prod.rendimento;
                    montante += rendimenti;
                    const carico = versamento * prod.carichi;
                    const comm = montante * prod.fees;
                    montante -= (carico + comm);

                    if (montante >= versamento * y) return y;
                }
                return durata;
            };

            const be1 = calcolaBreakEven(prod1);
            const be2 = calcolaBreakEven(prod2);

            [
                { nome: prod1.nome, anni: be1, risultato: results1 },
                { nome: prod2.nome, anni: be2, risultato: results2 }
            ].forEach(item => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div class="result-label">‚è±Ô∏è ${item.nome}</div>
                    <div class="result-value">${item.anni} anni</div>
                    <div style="font-size: 11px; margin-top: 8px; color: var(--text-light);">
                        ${item.anni <= 5 ? '‚úÖ Rapido' : item.anni <= 10 ? '‚ö†Ô∏è Medio' : '‚è≥ Lungo'}
                    </div>
                `;
                breakevenDiv.appendChild(card);
            });

            const breakEvenYears = [1, 5, 10, 15, 20];
            const serie1 = [], serie2 = [];

            breakEvenYears.forEach(y => {
                let m1 = 0, m2 = 0;
                for (let a = 1; a <= y; a++) {
                    m1 += versamento;
                    m2 += versamento;
                    const r1 = m1 * prod1.rendimento;
                    const r2 = m2 * prod2.rendimento;
                    m1 += r1 - (versamento * prod1.carichi) - (m1 * prod1.fees);
                    m2 += r2 - (versamento * prod2.carichi) - (m2 * prod2.fees);
                }
                serie1.push(m1);
                serie2.push(m2);
            });

            const ctx = document.getElementById('breakevenChart').getContext('2d');
            if (breakevenChartInstance) breakevenChartInstance.destroy();
            breakevenChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: breakEvenYears.map(y => `${y}y`),
                    datasets: [
                        { label: prod1.nome, data: serie1, borderColor: '#FF2D55', borderWidth: 3, fill: false },
                        { label: prod2.nome, data: serie2, borderColor: '#0066CC', borderWidth: 3, fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function displayInflazioneAnalisi(results1, results2, prod1, prod2, durata, inflazione) {
            const inflazioneDiv = document.getElementById('analisi-inflazione-grid');
            inflazioneDiv.innerHTML = '';

            const calcolaInflazione = (montante, anni, inflRate) => {
                return montante / Math.pow(1 + inflRate, anni);
            };

            const potenza1 = calcolaInflazione(results1.montanteNetto, durata, inflazione);
            const potenza2 = calcolaInflazione(results2.montanteNetto, durata, inflazione);
            const perditaPotenza1 = results1.montanteNetto - potenza1;
            const perditaPotenza2 = results2.montanteNetto - potenza2;

            [
                { nome: prod1.nome, lordo: results1.montanteNetto, potenza: potenza1, perdita: perditaPotenza1 },
                { nome: prod2.nome, lordo: results2.montanteNetto, potenza: potenza2, perdita: perditaPotenza2 }
            ].forEach(item => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.innerHTML = `
                    <div class="result-label">üìâ ${item.nome}</div>
                    <div style="font-size: 12px; margin-top: 8px; line-height: 1.6;">
                        <p><strong>Montante Netto:</strong> ‚Ç¨${parseFloat(item.lordo).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                        <p><strong>Potenza d'Acquisto:</strong> ‚Ç¨${parseFloat(item.potenza).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                        <p style="color: #E74C3C;"><strong>Perdita per Inflazione:</strong> ‚Ç¨${parseFloat(item.perdita).toLocaleString('it-IT', {minimumFractionDigits: 0})}</p>
                    </div>
                `;
                inflazioneDiv.appendChild(card);
            });
        }

        function displayFiscalitaDettagliata(results1, results2, prod1, prod2) {
            const tbody = document.querySelector('#analisi-fiscal-table tbody');
            tbody.innerHTML = '';

            [results1, results2].forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.nome}</td>
                    <td>‚Ç¨${parseFloat(r.montanteFinale).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${parseFloat(r.guadagno).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${parseFloat(r.irpef).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>‚Ç¨${parseFloat(r.montanteNetto).toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td>${r.rendimentoNetto.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function displayBenchmarking(results1, results2, durata) {
            const euribor = 3.5;
            const btp10y = 4.2;
            const msciWorld = 10;
            const inflazioneMean = 2.5;

            const ctx = document.getElementById('benchmarkChart').getContext('2d');
            if (benchmarkChartInstance) benchmarkChartInstance.destroy();
            benchmarkChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['EURIBOR 12M', 'BTP 10Y', 'MSCI World', 'Inflazione', results1.nome, results2.nome],
                    datasets: [{
                        label: 'Rendimento Annuale %',
                        data: [euribor, btp10y, msciWorld, inflazioneMean, results1.prod.rendimento * 100, results2.prod.rendimento * 100],
                        backgroundColor: ['#4285F4', '#34A853', '#FBBC04', '#EA4335', '#FF2D55', '#0066CC']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function generatePDFReport() {
            alert('üìÑ Funzione PDF disponibile nella versione desktop. Esportare in CSV per analisi.');
        }

        function exportAnalisiCSV() {
            const prod1 = document.getElementById('analisi-prodotto1').value;
            const prod2 = document.getElementById('analisi-prodotto2').value;

            let csv = 'REPORT ANALISI AVANZATA - VitaNuova Simulator Pro\n';
            csv += `Data: ${new Date().toLocaleDateString('it-IT')}\n`;
            csv += `Prodotto 1: ${prodotti[prod1].nome}\n`;
            csv += `Prodotto 2: ${prodotti[prod2].nome}\n\n`;

            const rows = document.querySelector('#analisi-fiscal-table tbody').querySelectorAll('tr');
            csv += 'STIMA FISCALE DETTAGLIATA\n';
            csv += 'Prodotto,Montante Lordo,Guadagno,IRPEF,Montante Netto,Rendimento Netto %\n';
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                csv += Array.from(cells).map(c => c.textContent).join(',') + '\n';
            });

            downloadFile(csv, 'analisi-avanzata.csv', 'text/csv');
        }

        function exportAnalisiJSON() {
            const prod1 = document.getElementById('analisi-prodotto1').value;
            const prod2 = document.getElementById('analisi-prodotto2').value;
            const versamento = document.getElementById('analisi-versamento').value;
            const durata = document.getElementById('analisi-durata-analisi').value;

            const json = JSON.stringify({
                data: new Date().toLocaleDateString('it-IT'),
                prodotto1: prodotti[prod1].nome,
                prodotto2: prodotti[prod2].nome,
                parametri: { versamento, durata },
                generatedBy: 'VitaNuova Simulator Pro - Analisi Avanzata'
            }, null, 2);

            downloadFile(json, 'analisi-avanzata.json', 'application/json');
        }

        function resetAnalisi() {
            document.getElementById('analisi-results').style.display = 'none';
            if (torteChartInstance) torteChartInstance.destroy();
            if (waterfallChartInstance) waterfallChartInstance.destroy();
            if (breakevenChartInstance) breakevenChartInstance.destroy();
            if (benchmarkChartInstance) benchmarkChartInstance.destroy();
        }

        // ===== EXPORT =====
        function exportToCSV(type) {
            let csv = `VitaNuova Simulator Pro - Esportazione ${type === 'pac' ? 'PAC' : type === 'tfr' ? 'TFR' : 'Investimenti'}\n`;
            csv += `Data: ${new Date().toLocaleDateString('it-IT')}\nUtente: ${currentUser}\n\n`;

            let tableId = type === 'pac' ? 'pac-table' : type === 'tfr' ? 'tfr-table' : 'investimenti-table';
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                csv += Array.from(cells).map(cell => cell.textContent).join(',') + '\n';
            });

            downloadFile(csv, `${type}-simulazione.csv`, 'text/csv');
        }

        function exportToJSON(type) {
            let tableId = type === 'pac' ? 'pac-table' : type === 'tfr' ? 'tfr-table' : 'investimenti-table';
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            const data = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowObj = {};
                cells.forEach((cell, idx) => {
                    rowObj[`col_${idx}`] = cell.textContent;
                });
                data.push(rowObj);
            });

            const json = JSON.stringify({
                date: new Date().toLocaleDateString('it-IT'),
                user: currentUser,
                type: type,
                data: data
            }, null, 2);

            downloadFile(json, `${type}-simulazione.json`, 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ===== AI ASSISTANT =====
        const AIAssistant = {
            conversationHistory: [],
            isOpen: false,

            patterns: {
                targetAmount: /(?:quanto|quanti|come)\s+(?:mi\s+serve|devo|metto)\s+(?:risparmiare|versare).*?(?:al\s+mese|annuale|ogni|mese|anno)?.*?(\d+[.,]?\d*)/i,
                timeToTarget: /(?:quanto\s+tempo|quanti\s+anni|in\s+quanto)\s+(?:ci\s+metto|impiego|serve).*?(?:a\s+)?raggiungere.*?(\d+[.,]?\d*)/i,
                whichProduct: /(?:quale|che|chi).*?mi\s+(?:conviene|serve|suggerisci).*?(?:PAC|TFR|investimenti?)/i,
                monthlyPayment: /(?:rata|versamento|contributo).*?(?:necessari|serve).*?(\d+[.,]?\d*)/i,
                strategy: /(?:cosa|come|strategia|piano)\s+(?:devo|faccio|fare).*?(?:mettere\s+da\s+parte|risparmiare|accumulare)/i,
                investmentAdvice: /(?:quale|che|come).*?(?:investire|scegliere).*?(?:‚Ç¨|euro)?(\d+[.,]?\d*)/i
            },

            init() {
                this.createChatButton();
                this.createChatPanel();
                this.attachEventListeners();
                this.loadConversationHistory();
            },

            createChatButton() {
                const button = document.createElement('button');
                button.id = 'ai-assistant-btn';
                button.innerHTML = 'ü§ñ Chiedi all\'AI';
                button.className = 'ai-assistant-btn';
                button.addEventListener('click', () => this.toggleChat());
                document.body.appendChild(button);
            },

            createChatPanel() {
                const panel = document.createElement('div');
                panel.id = 'ai-chat-panel';
                panel.className = 'ai-chat-panel';
                panel.innerHTML = `
                    <div class="ai-chat-header">
                        <h3>ü§ñ AI Assistant</h3>
                        <button class="ai-close-btn" onclick="AIAssistant.toggleChat()">‚úï</button>
                    </div>
                    <div class="ai-chat-messages" id="ai-messages"></div>
                    <div class="ai-chat-input-area">
                        <input type="text" id="ai-input" placeholder="Es: Quanto mi serve risparmiare per 100k?" />
                        <button onclick="AIAssistant.sendMessage()">Invia</button>
                    </div>
                `;
                document.body.appendChild(panel);
            },

            attachEventListeners() {
                const input = document.getElementById('ai-input');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            },

            toggleChat() {
                this.isOpen = !this.isOpen;
                const panel = document.getElementById('ai-chat-panel');
                panel.style.display = this.isOpen ? 'flex' : 'none';

                if (this.isOpen && this.conversationHistory.length === 0) {
                    this.addBotMessage('Ciao! üëã Sono il tuo AI Assistant. Posso aiutarti con:\n\nüí∞ "Quanto mi serve risparmiare per 100k in 10 anni?"\n‚è±Ô∏è "In quanto tempo raggiungo 50k con rata 500‚Ç¨?"\nüìä "Quale PAC mi conviene?"\nüí° E molto altro...');
                }
            },

            sendMessage() {
                const input = document.getElementById('ai-input');
                const message = input.value.trim();

                if (!message) return;

                this.addUserMessage(message);
                input.value = '';

                setTimeout(() => {
                    const response = this.processQuery(message);
                    this.addBotMessage(response);
                    this.saveConversationHistory();
                }, 500);
            },

            processQuery(question) {
                if (this.patterns.targetAmount.test(question)) {
                    const match = question.match(this.patterns.targetAmount);
                    const target = parseFloat(match[1].replace(',', '.'));

                    const durata = this.getCurrentDuration() || 10;
                    const rendimento = this.getCurrentReturn() || 0.045;

                    const rataAnnuale = this.calcolaRataAnnuale(target, durata, rendimento);
                    const rataMensile = rataAnnuale / 12;

                    return `üí° Per accumulare ‚Ç¨${target.toLocaleString('it-IT', {minimumFractionDigits: 0})} in ${durata} anni con rendimento ${(rendimento*100).toFixed(1)}%:\n\nüìä Rata mensile: ‚Ç¨${rataMensile.toFixed(2)}\nüìä Rata annuale: ‚Ç¨${rataAnnuale.toFixed(2)}\n\n‚úÖ Suggerimento: Usa il simulatore PAC per testare questa rata con diversi prodotti!`;
                }

                if (this.patterns.timeToTarget.test(question)) {
                    const match = question.match(this.patterns.timeToTarget);
                    const target = parseFloat(match[1].replace(',', '.'));

                    const rataMensile = this.getCurrentMonthlyPayment() || 500;
                    const rendimento = this.getCurrentReturn() || 0.045;

                    const anni = this.calcolaTempo(target, rataMensile * 12, rendimento);

                    return `‚è±Ô∏è Per accumulare ‚Ç¨${target.toLocaleString('it-IT', {minimumFractionDigits: 0})} con rata ‚Ç¨${rataMensile}/mese (${(rendimento*100).toFixed(1)}% rendimento):\n\nüìÖ Tempo necessario: ${anni.toFixed(1)} anni (${(anni*12).toFixed(0)} mesi)\n\nüí™ Questo √® ragionevole! Inizia subito con il piano PAC.`;
                }

                if (this.patterns.whichProduct.test(question)) {
                    return `üìä Dipende dai tuoi obiettivi:\n\nüî∑ PAC Vittoria: Perfetto per rischio basso, rendimento 4%\nüáÆüáπ PAC Italiana Bilanciata: Buon compromesso 4,5%\nüöÄ PAC Italiana Aggressiva: Se puoi attendere, 6,5%\nüéØ Allianz: Flessibilit√† massima\n\nüí° Consiglio: Usa il tab "Top 3 Prodotti" per un confronto automatico con i tuoi parametri!`;
                }

                if (this.patterns.strategy.test(question)) {
                    return `üí∞ Ecco la strategia consigliata:\n\n1Ô∏è‚É£ Calcola il tuo obiettivo (es. 100k)\n2Ô∏è‚É£ Scegli l\'orizzonte (es. 10 anni)\n3Ô∏è‚É£ Usa i nostri simulatori per trovare la rata\n4Ô∏è‚É£ Scegli il prodotto pi√π conveniente\n5Ô∏è‚É£ Rivedi il piano ogni anno\n\n‚úÖ Vuoi che inizi una simulazione? Dimmi l\'importo e gli anni!`;
                }

                return `ü§î Domanda interessante! Ecco come posso aiutarti:\n\nüí¨ Prova a chiedere:\n‚Ä¢ "Quanto mi serve risparmiare per 100k?"\n‚Ä¢ "In quanto tempo raggiungo 50k?"\n‚Ä¢ "Quale PAC mi conviene?"\n‚Ä¢ "Come faccio a risparmiare di pi√π?"\n\nüìä Oppure usa i simulatori direttamente nel tab appropriato!`;
            },

            calcolaRataAnnuale(target, anni, rendimento) {
                if (rendimento === 0) return target / anni;

                const fattore = ((1 + rendimento) ** anni - 1) / rendimento;
                return target / fattore;
            },

            calcolaTempo(target, rataAnnuale, rendimento) {
                if (rendimento === 0) return target / rataAnnuale;

                const numeratore = Math.log(1 + (target * rendimento / rataAnnuale));
                const denominatore = Math.log(1 + rendimento);
                return numeratore / denominatore;
            },

            getCurrentDuration() {
                const tabActive = document.querySelector('.tab-content.active');
                if (!tabActive) return 10;

                const select = tabActive.querySelector('select[id*="durata"]');
                return select ? parseInt(select.value) : 10;
            },

            getCurrentReturn() {
                const tabActive = document.querySelector('.tab-content.active');
                if (!tabActive) return 0.045;

                const scenario = document.getElementById('tfr-scenario');
                if (scenario) {
                    const scenarioValues = {
                        'conservativo': 0.025,
                        'equilibrato': 0.045,
                        'dinamico': 0.065,
                        'vittoria': 0.04,
                        'allianz': 0.050
                    };
                    return scenarioValues[scenario.value] || 0.045;
                }

                return 0.045;
            },

            getCurrentMonthlyPayment() {
                const tabActive = document.querySelector('.tab-content.active');
                if (!tabActive) return 500;

                const inputAnnuale = tabActive.querySelector('input[id*="versamento"]');
                return inputAnnuale ? parseInt(inputAnnuale.value) / 12 : 500;
            },

            addUserMessage(text) {
                const messagesDiv = document.getElementById('ai-messages');
                const msgEl = document.createElement('div');
                msgEl.className = 'ai-message user-message';
                msgEl.textContent = text;
                messagesDiv.appendChild(msgEl);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            },

            addBotMessage(text) {
                const messagesDiv = document.getElementById('ai-messages');
                const msgEl = document.createElement('div');
                msgEl.className = 'ai-message bot-message';
                msgEl.textContent = text;
                messagesDiv.appendChild(msgEl);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            },

            saveConversationHistory() {
                localStorage.setItem('aiConversation', JSON.stringify(this.conversationHistory));
            },

            loadConversationHistory() {
                const saved = localStorage.getItem('aiConversation');
                if (saved) this.conversationHistory = JSON.parse(saved);
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser && users[savedUser]) {
                currentUser = savedUser;
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').classList.add('active');
                document.getElementById('userName').textContent = currentUser;
            }
            AIAssistant.init();
        });

        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && document.getElementById('pwd') && document.getElementById('pwd').offsetParent !== null) {
                login();
            }
        });
    </script>
</body>
</html>
